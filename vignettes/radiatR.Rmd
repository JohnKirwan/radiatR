---
title: "radiatR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{radiatR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
if (requireNamespace("radiatR", quietly = TRUE)) {
  library(radiatR)
} else if (requireNamespace("pkgload", quietly = TRUE)) {
  # Load package from source when knitting the vignette interactively
  pkgload::load_all("..", export_all = FALSE, helpers = FALSE, quiet = TRUE)
} else {
  stop("Package 'radiatR' not installed and 'pkgload' not available. Install with remotes::install_local('.') or install.packages('pkgload').")
}
library(ggplot2)
```

## Overview

`radiatR` streamlines the journey from raw tracking files to publication-ready plots for experiments conducted in circular arenas. The package includes:

-   utilities for importing paired landmark/track text files produced by popular tracking suites;
-   helpers for extracting trial limits and computing circular summary statistics;
-   polished `ggplot2` layers for drawing concentric guides and annotated paths.

## Simulating Demo Data

Large tracking files are rarely suitable for inclusion in a package. To make example workflows reproducible, `simulate_tracks()` creates tidy demo data with controllable tortuosity.

```{r simulate}
# Simulated demo is a tibble; coerce to TrajSet for a single canonical workflow
sim_df <- simulate_tracks(n_trials = 4, n_points = 150, seed = 42)
ts <- TrajSet(
  sim_df,
  id = "trial_id",
  time = "frame",
  angle = "rel_theta",
  x = "rel_x",
  y = "rel_y",
  angle_unit = "radians",
  normalize_xy = FALSE
)
ts
```

With a `TrajSet` in hand, plotting is straightforward:

```{r radiate}
radiate(ts, group_col = "trial_id", colour_col = "tortuosity")
```

## File-Based Ingest Pipeline

When you have landmark/track text files on disk, the import helpers stitch them into tidy data structures. The example below creates a minimal synthetic data set to illustrate the workflow without requiring external assets.

```{r ingest}
tmp_dir <- tempfile("radiatr_ingest")
dir.create(tmp_dir)

# Write paired landmark/track files for a single video with two trials
landmarks <- data.frame(
  frame = c(1, 1, 120, 120),
  x = c(0, 40, 0, -35),
  y = c(0, 0, 0, 0)
)
tracks <- data.frame(
  frame = 1:200,
  x = c(seq(0, 25, length.out = 120), seq(25, -10, length.out = 80)),
  y = c(seq(0, 35, length.out = 120), seq(35, -5, length.out = 80))
)

write.table(
  landmarks,
  file = file.path(tmp_dir, "demo_video_point01.txt"),
  sep = "\t", col.names = FALSE, row.names = FALSE
)
write.table(
  tracks,
  file = file.path(tmp_dir, "demo_video_point02.txt"),
  sep = "\t", col.names = FALSE, row.names = FALSE
)

# Import metadata and enrich it with trial annotations
file_tbl <- import_tracks(tmp_dir)
manifests <- data.frame(
  file = file_tbl$basename,
  arc = c(0),
  type = "demo",
  obstacle = "none",
  id = "subject_01",
  stringsAsFactors = FALSE
)
file_tbl <- load_tracks(file_tbl, manifests, tmp_dir)

# Derive trial limits and normalised coordinates
landmarks_df <- read.delim(file.path(tmp_dir, file_tbl$landmark[1]),
                           header = FALSE)[, 1:3]
names(landmarks_df) <- c("frame", "x", "y")
tracks_df <- read.delim(file.path(tmp_dir, file_tbl$track[1]),
                        header = FALSE)[, 1:3]
names(tracks_df) <- c("frame", "x", "y")

trial_limits <- get_trial_limits(landmarks_df, tracks_df, file_tbl, vid_num = 1)
trial_ts <- get_tracked_object_pos(trial_limits, tracks_df)  # This is a TrajSet

trial_ts
```

The result is a `TrajSet` that stores trial-level metadata (including `trial_limits`) in `meta` and is ready to use with all downstream package functions. You can use it directly in visualisation or summary tools:

```{r ingest-plot}
radiate(
  trial_ts,                           # Directly plot the TrajSet
  group_col = "trial_id",
  colour_col = "video",
  label_col = "trial_id",
  show_arrow = TRUE
)
```

## Advanced: Accessing table-like data

You can still access the underlying data frame for legacy code or custom analysis, but the main workflow is TrajSet-centric:

```{r trajset-advanced}
head(trial_ts@data)
head(trial_ts@meta$trial_limits)
```

Remember to clean up when you are finished:

```{r cleanup, echo=FALSE}
unlink(tmp_dir, recursive = TRUE)
```
